
# IP协议
**IP首部格式**
![20200407141528](https://i.loli.net/2020/04/07/IkQnyVxG689paoh.png)

> - 4位版本：指明IPv4或IPv6
> - 总长度字段：整个IP数据报的长度，字节为单位
> - 16位标识：唯一标识主机发送的每一份数据报，通常每发送一份报文值就加1
> - 3位标志：前1位保留，第2位DF不分片标志，DF=0表示已经分片；第3位MF更多分片，MF=0表示该数据报是最后一个分片
> - 8位生存时间TTL：当前主机到目的主机的路由器间最大跳数，每经过一个路由器便减1，TTL=0则丢弃数据报。目的为了防止出现循环回路，且TTL=0时会发送不可达ICMP给源IP
> - 13位偏移量：以8字节为单位，计算从数据报开始的片段偏移量

## IP分片
**作用**：IP数据报最大长度65535字节，超过了链路层最大传输单元MTU的限制。
> **分片缺点**：
> 1. IP层没有超时重传机制，一个分片丢失，所有分片都要依赖传输层协议重传一遍，降低传输数据的成功率
> 2. 分片、重组带来性能消耗
> 3. 有安全隐患
> 
> 因此IPv6不允许路由器执行分片，在发送数据包之前确定MTU

### 避免IP分片
1. TCP协议通过三次握手的过程，互相通告最大报文段长度MSS(MTU1500 - IP首部20 - TCP首部20 = 1460字节)，每次发送数据不会超过MSS
2. UDP包在应用层限制每个包大小不超过MTU1500 - IP首部20 - UDP首部8 = 1472字节

## IP选路

概念：搜索路由表并决定向哪个网络接口发送分组
> 相关命令
> - 列出主机当前路由表`netstat -rn`
> - 手动添加路由`route`
> 
**路由表**

| 目的网络IP地址 | 子网掩码 | 下一跳IP地址 | 接口 |
| -------------- | -------- | ------------ | ---- |

路由表包含：
1. 网络 ID（Network ID, Network number）：就是目标地址的网络 ID。
2. 子网掩码（subnet mask）：用来判断 IP 所属网络
3. 下一跳地址/接口（Next hop / interface）：就是数据在发送到目标地址的旅途中下一站的地址。其中 interface 指向 next hop（即为下一个 route）。一个自治系统（AS, Autonomous system）中的 route 应该包含区域内所有的子网络，而默认网关（Network id: 0.0.0.0, Netmask: 0.0.0.0）指向自治系统的出口。

根据应用和执行的不同，路由表可能含有如下附加信息：
1. 花费（Cost）：就是数据发送过程中通过路径所需要的花费。
2. 路由的服务质量
3. 路由中需要过滤的出/入连接列表
  





# ICMP协议
**作用**：ICMP封装在IP数据报内部，用来发送网络控制消息，包括主机探测、路由维护、IP选路等
![20200407141547](https://i.loli.net/2020/04/07/nBOiT2lJNDgLKvE.png)

## 报文分类

应用：
- PING（Packet InterNet Groper，分组网间探测）测试两个主机之间的连通性
  - TTL（Time To Live，生存时间）该字段指定 IP 包被路由器丢弃之前允许通过的最大网段数量

# NAT协议
http://www.52im.net/thread-50-1-1.html

NAT穿透 http://www.52im.net/thread-50-1-1.html