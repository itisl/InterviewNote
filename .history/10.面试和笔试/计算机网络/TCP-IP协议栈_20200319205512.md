[TOC]
---

## 网络协议模型

OSI参考模型是国际标准，TCP/IP模型是这一标准的具体实现

![20200318161743.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200318161743.png)
> 1. 物理层：定义物理设备标准，如网线接口类型、介质传输速率。面向比特流(Bit)
> 2. 数据链路层：主机间通信。数据链路层在不可靠的物理介质上提供可靠的传输。面向以太网帧(Frame)
> 3. 网络层：网络层负责对子网间的数据包进行**路由选择**，以及实现拥塞控制、网络互连等功能。面向数据包(Packet)
> 4. 传输层：传输层的功能是使源端主机和目标端主机上的对等实体可以进行会话，即**端口到端口**的连接(Segment)
> 5. 会话层、表示层、应用层：规定应用程序的数据格式


###### TCP/IP数据包封装
用户数据自顶向下层层封装，传输到目的主机再自底向上得到用户数据。

![20200318190004.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200318190004.png)

### 网络接口层
#### 以太网帧

**以太网首部**

![20200318200200.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200318200200.png)

> - 目的地址/源地址：通信双方的MAC地址，目的地址未知时用`FF:FF:FF:FF:FF:FF`填充
> - 类型：协议类型编码
> - 数据：不超过最大传输单元MTU(1500)字节，因此以太网帧范围为64~1518。MTU的选择是资源占用和效率的综合考量
> - CRC：尾部校验，提供差错控制

**MAC地址：**
> 网卡的硬件地址，6字节48位，前24位用于分配给不同厂商，后24位厂商自己分配，全球唯一。系统中的MAC地址是ARP协议ROM中记录的硬件地址，是可以修改的，因此可能有两个相同的MAC地址

#### ARP协议
**作用**：获取局域网中目标主机的物理地址(MAC地址)
> **ARP协议流程**
> 1. 检查ARP缓存表，查看目的主机是否有IP地址对应的目的MAC；
> 2. 目的地址未知时用`FF:FF:FF:FF:FF:FF`填充，并发送广播帧，交换机将广播帧转发
> 3. 所有收到帧的主机会解析目的地址为`FF:FF:FF:FF:FF:FF`的以太帧，如果IP地址符合则接收，并将其IP和MAC记录到ARP缓存表，同时发送ARP应答
> 4. 源主机收到应答后记录目的主机的MAC地址

#### RARP协议
**作用**：利用MAC地址获取目标主机的IP地址(已经被DHCP协议取代)
> **RARP协议流程**
> 1. 发送主机发送一个本地的RARP广播，在此广播包中，声明自己的MAC地址并且请求任何收到此请求的RARP服务器分配一个IP地址；
> 2. 本地网段上的RARP服务器收到此请求后，检查其RARP列表，查找该MAC地址对应的IP地址；
> 3. 如果存在，RARP服务器就给源主机发送一个响应数据包并将此IP地址提供给对方主机使用；如果不存在，RARP服务器对此不做任何的响应；
> 4. 源主机收到从RARP服务器的响应信息，就利用得到的IP地址进行通讯；如果一直没有收到RARP服务器的响应信息，表示初始化失败。

### 网络层
#### IP协议
##### IP首部格式

![20200319155018.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319155018.png)

> - 4位版本：指明IPv4或IPv6
> - 总长度字段：整个IP数据报的长度，字节为单位
> - 16位标识：唯一标识主机发送的每一份数据报，通常每发送一份报文值就加1
> - 3位标志：前1位保留，第2位DF不分片标志，DF=0表示已经分片；第3位MF更多分片，MF=0表示该数据报是最后一个分片
> - 8位生存时间TTL：当前主机到目的主机的路由器间最大跳数，每经过一个路由器便减1，TTL=0则丢弃数据报。目的为了防止出现循环回路，且TTL=0时会发送不可达ICMP给源IP
> - 13位偏移量：以8字节为单位，计算从数据报开始的片段偏移量
##### IP分片
**作用**：IP数据报最大长度65535字节，超过了链路层最大传输单元MTU的限制。
> **分片缺点**：
> 1. IP层没有超时重传机制，一个分片丢失，所有分片都要依赖传输层协议重传一遍，降低传输数据的成功率
> 2. 分片、重组带来性能消耗
> 3. 有安全隐患
> 
> 因此IPv6不允许路由器执行分片，在发送数据包之前确定MTU

##### 避免IP分片
1. TCP协议通过三次握手的过程，互相通告最大报文段长度MSS(MTU1500-IP首部20-TCP首部20=1460字节)，每次发送数据不会超过MSS
2. UDP包在应用层限制每个包大小不超过MTU1500-IP首部20-UDP首部8=1472字节

##### IP选路
#### ICMP协议
ICMP封装在IP数据报内部
![20200319140517.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319140517.png)
##### 报文分类
###### 查询
###### 差错
##### 应用
###### ping

### 传输层
#### UDP协议
**UDP封装**

![20200319150930.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319150930.png)

**UDP首部**

![20200319151201.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319151201.png)

> 特点：
> - 无连接
> - 尽最大努力交付
> - 面向应用程序交付的报文(对报文不拆分不合并)
> - 没有流量控制
> - 支持一对一、多对多的交互通信(视频、语音等)

#### TCP协议
##### 首部格式

![20200319155221.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319155221.png)

> TCP首部
> 1. 序号seq：16位(4字节)，本报文段发送第一个字节的序号
> 2. 确认号ack：16位，期望收到的下一个报文的seq
> 3. 数据偏移：首部长度
> 4. ACK：只有ACK=1时，确认号ack才有效
> 5. 复位RST：表明连接中出现严重差错，需要重新建立连接
> 6. 同步SYN：仅用于建立连接时，SYN=1表示请求连接或接受连接
> 7. 终止FIN：仅用于释放连接，FIN=1表示数据发送完毕，请求释放连接
> 8. 窗口字段：向对方建议发送窗口的大小
> 9. 选项字段：包括最大报文段长度MSS等

> TCP连接特点：
> - 面向连接
> - 提供全双工通信
> - 每个连接只能有两个端点(一对一)
> - 提供可靠交付的服务
> - 面向字节流
##### 连接控制
###### 三次握手

![20200319202731.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319202731.png)


###### 四次挥手

![20200319202831.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319202831.png)

> 
> 请画出三次握手和四次挥手的示意图
> 为什么连接的时候是三次握手？
> 什么是半连接队列？
> ISN(Initial Sequence Number)是固定的吗？
> 三次握手过程中可以携带数据吗？
> 如果第三次握手丢失了，客户端服务端会如何处理？
>     服务端状态为SYN_RECV,并且会根据TCP的超时重传机制，会等待1秒、2秒、4秒后重新发送SYN+ACK包，以便Client重新发送ACK包如果重传都一直失败，会在指数退避达64s后发RTS包，断开连接。
> SYN攻击是什么？
> 挥手为什么需要四次？
> 四次挥手释放连接时，等待2MSL的意义?
###### `TIME_WAIT`、`CLOSE_WAIT`
##### 流量控制
![20200319202706.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319202706.png)
###### 滑动窗口
![20200319200118.png](https://raw.githubusercontent.com/itisl/Pic_Bed/master/img/20200319200118.png)
###### 慢启动
###### 拥塞避免
###### 超时重传
###### 快速重传
###### 快速恢复

##### 建立TCP
### 应用层
#### DNS协议
域名系统（DNS）是一个分布的数据库，由它来提供IP地址和域名之间的映射信息
##### 名字空间
##### DNS指针查询
##### DNS缓存
#### FTP协议
##### 工作模式
PASV
PORT
##### 指令和响应码
##### 断点续传
##### 匿名FTP
#### HTTP协议
##### 报文格式
##### HTTP状态码
#### HTTPS协议
##### 详细握手过程
##### 摘要算法
##### 数字签名
##### 数字证书

#### 常用端口号

| 端口号   | 服务                                             |
| -------- | ------------------------------------------------ |
| 21端口   | FTP 文件传输服务                                 |
| 22端口   | SSH 端口                                         |
| 23端口   | TELNET 终端仿真服务                              |
| 25端口   | SMTP 简单邮件传输服务                            |
| 53端口   | DNS 域名解析服务                                 |
| 80端口   | HTTP 超文本传输服务                              |
| 110端口  | POP3 “邮局协议版本3”使用的端口                   |
| 443端口  | HTTPS 加密的超文本传输服务                       |
| 1433端口 | MS SQL*SERVER数据库 默认端口号                   |
| 1521端口 | Oracle数据库服务                                 |
| 1863端口 | MSN Messenger的文件传输功能所使用的端口          |
| 3306端口 | MYSQL 默认端口号                                 |
| 3389端口 | Microsoft RDP 微软远程桌面使用的端口             |
| 5631端口 | Symantec pcAnywhere 远程控制数据传输时使用的端口 |
| 5632端口 | Symantec pcAnywhere 主控端扫描被控端时使用的端口 |
| 5000端口 | MS SQL Server使用的端口                          |
| 8000端口 | 腾讯QQ                                           |