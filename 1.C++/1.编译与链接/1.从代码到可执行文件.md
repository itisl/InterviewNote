# 编译与链接



### C++文件格式
| 编译器 | Microsoft Visual C++ | GCC（GNU C++）       | Borland C++ | UNIX       |
| ------ | -------------------- | -------------------- | ----------- | ---------- |
| 源文件后缀   | `.cpp` `.cxx` `.cc`         | `.cpp` `.cxx` `.cc` `.c++` `.C` | `.cpp`        | `.C` `.cc` `.cxx` |
### 从代码到可执行文件

**C++从源代码生成可执行文件的过程：**

![从源代码生成可执行文件的过程](https://i.loli.net/2020/04/07/rQM7z2lH8OhTunt.png)

1. **预处理阶段**：对源代码文件中文件包含关系（头文件）、预编译语句（宏定义）进行分析和替换，生成预编译文件。 
2. **编译阶段**：将经过预处理后的预编译文件转换成特定汇编代码，生成汇编文件 
3. **汇编阶段**：将编译阶段生成的汇编文件转化成机器码，生成可重定位目标文件 
4. **链接阶段**：将多个目标文件及所需要的库连接成最终的可执行目标文件


**程序的生命周期阶段**

![程序的生命周期阶段](https://i.loli.net/2020/04/07/jL94OxmlDbGuY7P.png)


## 如何运行一个C++程序？

### 使用`g++`命令行编译链接(Linux)
> 常用命令
> - `-c` 生成`.o`目标文件
> - `-o`生成可执行文件
> - `-shared` 指定生成动态链接库
> - `-L` 要链接的库所在目录
> - `-l` 指定链接时需要的动态库，隐含命名规则，即在前加`lib`，在后加`.a`或`.so`确定库文件名

#### 1. 编译
> `-E`预处理命令，宏的替换，还有注释的消除，还有找到相关的库文件，生成Test.i文件
```sh
g++ -E Test.cpp
```
> `-S`命令将文件转换为汇编文件，生成Test.s文件
```sh
g++ -S Test.cpp
```

#### 2. 目标代码
> `-c`命令将文件转换为目标文件，生成Test.o文件

```sh
g++ -c Test.cpp
```

#### 3. 生成库文件
##### 动态库
```sh
g++ Test.cpp -fPIC -shared -o libTest.so
```
##### 静态库
```sh
ar cr libTest.a Test.o
```

#### 4. 链接
> `-o`命令生成可执行文件out(或out.exe)，`-L`命令链接库文件路径，`-l`链接动态链接库`.so`

```sh
g++ Test.cpp -L /usr/include/iostream -l Test -o out
```

