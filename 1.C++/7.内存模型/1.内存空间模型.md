## 进程内存分布

32位系统的进程内存布局：
![11111](https://i.loli.net/2021/03/16/2uFlfg9zshrMXad.jpg)
#### Kernel space
内核区，供操作系统使用，用户代码不能读写该地址，往只读段读写会报段错误“segmentation fault"

#### Stack
栈区，每次调用函数会给它自动分配一段连续的栈空间，存放函数的返回地址、参数、局部变量、返回值、上下文（函数调用前后需要保持不变的寄存器），函数调用完自动分配和回收。**从高地址向低地址增长**，在创建进程时会有一个最大栈大小，Linux可以通过ulimit命令指定


#### Memory Mapping Segment
将文件映射到内存或匿名映射，比如用于动态链接的共享库libgl.so的存放，可用于申请大内存

#### Heap（自由存储区）
堆区，在程序运行过程中可以动态增加堆大小(移动break指针)，**从低地址向高地址增长**,堆的起始地址由`mm_struct`结构体中的`start_brk`标识，结束地址由`brk`标识。程序运行过程中，为了能自由控制内存的生命周期、大小，会经常使用堆空间内存
C++自由存储区`new`/`delete`运算符动态分配和释放空间的内存分区的抽象概念，`new`操作符申请的内存可以称为自由存储区，堆与自由存储区并不等价。一般C++编译器用堆来实现自由存储，也可以用其他内存

#### BSS segment
BSS段，未初始化的静态变量（局部/全局）和全局变量会存放在bss段，并**自动被初始化为`0`**，未指定初始化的全局变量和静态变量（包括类的对象），都会自动被初始化为`0`
> tips：自定义了构造函数的类，显示指定了初始化的变量会被初始化为指定值，其他值初始化为`0`

#### Data segment
数据段（全局区），用于存放已初始化的全局变量、静态变量


#### Text segment
代码段，包括文本区和存储区，文本区存储文字常量（包括**符号常量**和**字面常量**），存储区用于存放程序的镜像机器代码，只读
> 参考书籍上说字符串常量不在代码区，存储在常量区，从代码分析可认为几乎是同一个区

### 内存地址分析
```cpp
static int a = 1;
int b = 3;
static int c;
int d;
void hello(){}

int main() {
    int e;
    // a, b地址相邻，说明已初始化的静态变量a和全局变量b在同一区域Data segment
    cout << &a << endl; //0x7ff6a2e02010
    cout << &b << endl; //0x7ff6a2e02014
    // c, d地址相邻，但和a, b地址不相邻，说明未显式初始化的静态/全局变量在距离
    // Data segment相近的BSS segment
    cout << &c << endl; //0x7ff6a2e0213c
    cout << &d << endl; //0x7ff6a2e02134
    // 栈和堆地址都距全局变量较远，且堆的内存地址在较低位
    cout << &e << endl; //0x7fffd075521c
    cout << p << endl;  //0x7fffc7b78e70

    // 字符串常量相邻，和代码段(函数)距离相近
    cout << ( void* )("Hello World") << endl; //0x7ff6a2c00e40
    cout << ( void* )("Oh My God") << endl; // 0x7ff6a2c00e4c
    cout << (void*)hello << endl; //0x7ff6a2c00b2a
    return 0;
}
```


## ELF文件格式
Linux系统上可执行文件为ELF文件

| 数据段      | 说明                           |
| ----------- | ------------------------------ |
| ELF头       | 固定长度，索引到**表**         |
| 程序头表    | 可选，记录文件节装载到内存段的位置 |
| `.init`节   |                                |
| `.text`节   | 代码段                         |
| `.rodata`节 | 只读数据                       |
| `.data`节   | 已初始化全局变量               |
| `.bss节`    | 未初始化全局变量               |
| `.systab`节 | 符号表                         |
| ...         | 其他                           |
| `.strtab`节 | 字符串表                       |
| 节头表      | 索引到**节**                   |
